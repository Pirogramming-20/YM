{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Chat Room</title>
  </head>
  <body>
    <style>
      ul {
        padding: 0;
      }
      li {
        display: flex;
        margin: 2px 20px;
      }
      .my_chat {
        flex-direction: row-reverse;
      }
    </style>
    <div id="info_room_num">{{room.id}}</div>
    <div id="info_room">{{room.room_name}}</div>
    {% if user.is_authenticated %}

    <div class="connect-user-hi">
      <span id="info_username">{{user.username}} </span> 님이 로그인중
    </div>
    <a href="{% url 'main:logout' %}">
      <div class="header-btn">로그아웃</div>
    </a>
    <!-- 접속중인 유저 표시 -->
    <ul id="users"></ul>
    <a href="{% url 'movieGames:movie_game_main' %}">
      <div class="header-btn">영화게임하기</div>
    </a>
    <a href="{% url 'musicGames:music_game_main' %}">
      <div class="header-btn">노래게임하기</div>
    </a>
    <a href="{% url 'figure:figure_main' %}">
      <div class="header-btn">인물퀴즈</div>
    </a>
    <a href="{% url 'fourWords:figure_main' %}">
      <div class="header-btn">네글자 게임</div>
    </a>
    <div>{{qrimg}}</div>
    <img src="{{qrimg}}" alt="qrcode" />
    <img src="{% static 'image/qrcode/qr.png' %}" alt="이미지" class="photo" />
    <!-- 채팅 입력 칸 생성 -->
    <input id="input" autocomplete="off" />
    <div onclick="click1()">Send</div>
    <!-- 입력된 채팅들이 기록될 공간 -->
    <ul id="messages"></ul>

    {% endif %}

    <script
      src="https://cdn.socket.io/4.0.1/socket.io.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      const room_num = document.getElementById("info_room_num").innerText;
      const room_name = document.getElementById("info_room").innerText;
      const username = document.getElementById("info_username").innerText;
      console.log(room_num);
      console.log(room_name);
      console.log(username);

      let socket = io.connect(
        location.protocol + "//" + document.domain + ":" + location.port
      );
      socket.emit("join", room_name);

      // 소켓서버에서 받은 데이터를 기반으로 html에 코드 추가
      socket.on("message", function (data) {
        console.log("msg");
        console.log(data);
        let li = document.createElement("li");
        li.append(
          document.createTextNode(data[1]),
          document.createTextNode(" : "),
          document.createTextNode(data[0])
        );
        if (data[1] == username) {
          li.className += "my_chat";
        }
        document.getElementById("messages").appendChild(li);
      });

      // 메시지 전송버튼이 눌렸을때 입력된 메세지를 소켓을 통해 보내고 메세지 입력창을 비움
      function click1() {
        console.log("clk");
        let text = document.getElementById("input").value;
        console.log("clk2");
        socket.emit("message", text, username, room_name);
        document.getElementById("input").value = "";
      }
      document
        .getElementById("input")
        .addEventListener("keydown", function (e) {
          if (e.keyCode === 13) {
            // 'Enter'키의 keyCode는 13입니다.
            let text = e.target.value;

            socket.emit("message", text, username, room_name);
            e.target.value = "";
          }
        });
    </script>
  </body>
</html>
