{% extends 'base.html' %} {% block content %}{% load static %}

<div class="game">
  <div class="quiz">
    <div class="quiz-container">
      <div class="image-cover">
        <span class="countdown text2">사진</span>
      </div>
      <div class="photo-container">
        <img src="{{ quiz.movie_game_id.scene }}" alt="이미지" class="photo" />
      </div>
    </div>
    <div class="answer-container">
      <div class="title text1"></div>
      <div class="line text2"></div>
    </div>
    <div class="game-btn-container">
      <button class="game-btn main-btn btn-text"onclick="startCountdown()">
        시작
        <i class="fa-solid fa-play"></i>
      </button>
      <div class="game-btn next-btn main-btn btn-text" onclick="reset_animation()">
          다음 문제
          <i class="fa-solid fa-chevron-right"></i>
      </div>
      <div class="game-btn answer-btn main-btn btn-text"><i class="fa-solid fa-circle-check"></i> 정답 </div>
      <a class="game-btn game-over main-btn btn-text" href="/chatting-room/next_game/{{roomId}}">다음게임           <i class="fa-solid fa-chevron-right"></i>
      </a>
    </div>
  </div>
  <div class="chat-container">
    {%include "chat-base.html"%}
  </div>
</div>

{% endblock %} {% block script %}
<script
  src="https://cdn.socket.io/4.0.1/socket.io.min.js"
  crossorigin="anonymous"
></script>
<script>
  const room_name = "movieGame";
  const username = document.getElementById("info_username").innerText;
  console.log(username);

  let socket = io.connect(
    location.protocol + "//" + document.domain + ":" + location.port
  );
  socket.emit("join", room_name);

  // 소켓서버에서 받은 데이터를 기반으로 html에 코드 추가
  socket.on("message", function (data) {
    console.log("msg");
    console.log(data);
    let li = document.createElement("li");
    li.append(
      document.createTextNode(data[1]),
      document.createTextNode(" : "),
      document.createTextNode(data[0])
    );
    if (data[1] == username) {
      li.className += "my_chat";
    }
    document.getElementById("messages").appendChild(li);
  });

  // 메시지 전송버튼이 눌렸을때 입력된 메세지를 소켓을 통해 보내고 메세지 입력창을 비움
  function click1() {
    console.log("clk");
    let text = document.getElementById("input").value;
    console.log("clk2");
    socket.emit("message", text, username, room_name);
    document.getElementById("input").value = "";
  }
  document.getElementById("input").addEventListener("keydown", function (e) {
    if (e.keyCode === 13) {
      // 'Enter'키의 keyCode는 13입니다.
      let text = e.target.value;

      socket.emit("message", text, username, room_name);
      e.target.value = "";
    }
  });
</script>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  //카운트다운
  const imageCover = document.querySelector(".image-cover");
  const countdownElement = document.querySelector(".countdown");
  let countdownInterval;

  function startCountdown() {
    imageCover.style.display = "flex";
    let count = 3;

    countdownInterval = setInterval(() => {
      if (count <= 0) {
        clearInterval(countdownInterval);
        imageCover.style.display = "none";
      } else {
        countdownElement.textContent = count;
        count--;
      }
    }, 1000);
  }

  const requestQuiz = new XMLHttpRequest();
  let currentQuizId = "{{ quiz.id }}";
  const nextBtn = document.querySelector(".next-btn");
  let cnt = 1;
  function reset_animation() {
    const quizContainer = document.querySelector('.quiz');
    quizContainer.style.animation = 'none';
    quizContainer.offsetHeight; /* trigger reflow */
    quizContainer.style.animation = null; 
  }

  nextBtn.addEventListener("click", function () {
    imageCover.style.display = "flex";
    countdownElement.textContent = "사진";
    const url = "/movie/next/";
    requestQuiz.open("POST", url, true);
    requestQuiz.setRequestHeader("Content-Type", "application/json");
    requestQuiz.setRequestHeader("X-CSRFToken", csrftoken);
    requestQuiz.send(JSON.stringify({ id: currentQuizId }));
    const title_element = document.querySelector(".title");
    title_element.innerHTML = "";

    const line_element = document.querySelector(".line");
    line_element.innerHTML = "";
   
  });

  requestQuiz.onreadystatechange = () => {
    if (requestQuiz.readyState === XMLHttpRequest.DONE) {
      if (requestQuiz.status < 400) {
        const { id, scene } = JSON.parse(requestQuiz.response);

        const photo_element = document.querySelector(".photo");
        photo_element.src = scene;

        currentQuizId = id;
        cnt++;
        if (cnt === parseInt("{{ count }}")) {
          nextBtn.innerText = "마지막 문제";
        }
      }
    }
  };
  
  const answerBtn = document.querySelector(".answer-btn");
  const requestAnswer = new XMLHttpRequest();

  answerBtn.addEventListener("click", function () {
    const url = "/movie/answer/";
    requestAnswer.open("POST", url, true);
    requestAnswer.setRequestHeader("Content-Type", "application/json");
    requestAnswer.setRequestHeader("X-CSRFToken", csrftoken);
    requestAnswer.send(JSON.stringify({ id: currentQuizId }));
  });

  requestAnswer.onreadystatechange = () => {
    if (requestAnswer.readyState === XMLHttpRequest.DONE) {
      if (requestAnswer.status < 400) {
        const { id, title, line } = JSON.parse(requestAnswer.response);

        const title_element = document.querySelector(".title");
        title_element.innerHTML = title;

        const line_element = document.querySelector(".line");
        line_element.innerHTML = line;
      }
    }
  };
</script>
  
  

{% endblock %}
